<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <title>Drawing and updating</title>
  </head>
  <body>
    <div id="target">
      <p>
        Target positions will be shown here.
      </p>
    </div>
    <div id="game">
      <canvas id="game-canvas"></canvas>
    </div>
    <div id="editor"> </div>
    <div id="editor-controllers">
      <a id="load-link">Load</a>
      <a id="run-link">Run</a>
      <a id="step-link">Step</a>
    </div>
  </body>

  <!--load game library and the game -->
  <script src="luv.js"></script>

  <script src="game-js/utils.js"></script>
  <script src="game-js/world.js"></script>

  <script src="game-js/engine.js"></script>
  <script src="game-js/gui.js"></script>

  <!-- load the editor -->
  <script src="codemirror-compressed.js"></script>
  <script src="botlang/mode.js"></script>
  <link rel="stylesheet" href="codemirror-3.11/lib/codemirror.css">
  <link rel="stylesheet" href="codemirror-3.11/theme/ambiance.css">

  <!-- load parser -->
  <script src="game-js/parser.js"></script>

  <script type="text/javascript">
    // OMG javascript sucks so hard ..
    // var id = document.getElementById doesn't work for some reason, but this works fine.
    // this is stupid.
    var id = function (s) { return document.getElementById(s); }
    CodeMirror.defineMode("botlang", BotlangMode);
    var cm = CodeMirror(id("editor"), { theme: "ambiance", lineNumbers: true, indentWithTabs: true, mode: "botlang" });


    var runBtn = id("run-link");
    var stepBtn = id("step-link");
    var loadBtn = id("load-link");

    var lvl;
    try {
      var query = window.location.search; 
      if (query.length != 0) {
        lvl = levelFromString(query.slice(1));
      } else {
        throw undefined;
      }
    } catch (e) {
      console.log("error while creating from the query.");
      lvl = new Level(
        [["b", "b", "b"], [], ["r", "r", "r"]],
        [[], [], ["b", "r", "b", "r", "b", "r"]]);
    }

    console.log(lvl);

    var program = parser.parse("program1: move left move left down down");

    mainGui = Luv({
      el: id("game-canvas"),
      width: 600,
      height: 400
    });
    mainGui.MAX_BLOCKS_WIDTH = 10;
    mainGui.MAX_BLOCKS_HEIGHT = 8;
    mainGui.BLOCK_WIDTH = mainGui.graphics.getWidth() / mainGui.MAX_BLOCKS_WIDTH;
    mainGui.BLOCK_HEIGHT = mainGui.graphics.getHeight() / mainGui.MAX_BLOCKS_HEIGHT;


    var gui = new Gui(mainGui, 8, 1.5)
    mainGui.update = function (dt) {
      gui.update(dt);
    };
    mainGui.draw = function () {
      gui.draw();
    };
    mainGui.run();
    var engine = new GameEngine(lvl, program, gui, true)

    loadBtn.onclick = function () {
      var val = parser.parse(cm.doc.getValue());
      console.log(val);
      engine = new GameEngine(lvl, val, gui, true)
    };

    stepBtn.onclick = function () {
      engine.step()
    };

    //Game.loadLevel([ "ggg", "rrr", "ggg", "rgb", "bgr", "rgb", "bbb", "rrr", "ggg", "rrr" ]);
  </script>


</html>
